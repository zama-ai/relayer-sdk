name: npm-publish

on:
  release:
    # 'published' fires for both stable releases and prereleases
    types: [published]

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    name: npm-publish/publish
    permissions:
      security-events: 'write' # Required for zizmor to upload its results.
      id-token: 'write' # Required by npm publish
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: 'false'

      - name: Set up Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22.x
          cache: 'npm'

      - name: Update npm
        run: npm install -g npm@11.7.0

      - name: Install dependencies
        run: npm ci

      - name: Run prettier
        run: npm run prettier:check

      - name: Run lint
        run: npm run lint

      - name: Run strict build
        run: npm run build:strict

      - name: Build package
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          persona: pedantic
          version: 1.18.0

      - name: Set NPM version tag to latest
        if: ${{ github.event_name == 'release' && !github.event.release.prerelease }}
        run: |
          echo "NPM_TAG=latest" >> "${GITHUB_ENV}"

      - name: Set NPM version tag to prerelease
        if: ${{ github.event_name == 'release' && github.event.release.prerelease }}
        run: |
          echo "NPM_TAG=prerelease" >> "${GITHUB_ENV}"

      - name: Set NPM version tag for manual trigger
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "NPM_TAG=test" >> "${GITHUB_ENV}"

      - name: Publish relayer-sdk to npm
        uses: JS-DevTools/npm-publish@7f8fe47b3bea1be0c3aec2b717c5ec1f3e03410b # v4.1.1
        with:
          provenance: true
          package: ./package.json
          # Run in dry-run mode for testing purpose
          dry-run: false
          tag: ${{ env.NPM_TAG }}
          access: public
