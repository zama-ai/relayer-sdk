import createHash from 'keccak';
import { ethers } from 'ethers';
import type {
  Bytes32Hex,
  BytesHex,
  ChecksummedAddress,
  EncryptionBits,
} from '../types/primitives';
import { hexToBytes } from '../utils/bytes';
import { FhevmHandle } from '../sdk/FhevmHandle';
import { MAX_UINT64 } from '../utils/uint';
import { fheTypeIdFromEncryptionBits } from '../sdk/FheType';
import { ZKProof } from '../sdk/ZKProof';

// npx jest --colors --passWithNoTests ./src/relayer/handles.test.ts

const DATA: {
  ciphertextWithZKProof: BytesHex;
  bitwidths: EncryptionBits[];
  aclAddress: ChecksummedAddress;
  chainId: number;
  ciphertextVersion: number;
  handles: Bytes32Hex[];
  userAddress: ChecksummedAddress;
  contractAddress: ChecksummedAddress;
} = {
  ciphertextWithZKProof:
    '0x0300000000000000302e35000000000300000000000000302e312b00000000000000686967685f6c6576656c5f6170693a3a50726f76656e436f6d70616374436970686572746578744c697374000000000000000000000000010000000000000002000000000000000808000000000000e9cbaf9ea80450f3287879acd9734bcdb6ef4dc516317075288a9c97c2b4c8d56cdbd533f8d11ab972715e7f084a16e1dde0c480217e0b49d07526685fe9e82f2979d3dc013c9992fbe356d4b990341a0db1ef021f75cefb05ada8ed514b620ea405eab7aa01a3b89bdca864a101516c0cd62fe187da87ed67489f2dbf820091045dc331a2893b8523afdb85c8b1314bf53f347532b8bdb1dfc6dec0818d7ac7abebe5583a0808b2ac3cd5f917add6c40b88c380b8459723128ff102a941a1635cabf6a3168a9220fb55896f3d1f96c3eef6c731fb204f48af4a45a46fcb60bf3e1a3fbeee6aa4f3ab0f832e80499254c4289ca42caa72bde21eccad17a3a04c3b46cca54ab17d2b87518df2e1646a5604e39581715f27ef84ea691131758b9040fef72c66805955cac984346b4109d7196c07566cfa70c3ba75be0c95860406ea857dde7642ae3e403002da03b64d5e2597126a17dc16019312fc54c2580c920763ef5c4279c7b6b622e6c0deebec4670b3829a0d1dd4d9c215e68d53e06cc85988736ac700e94d8576886748aed325ade9ab15d3c2a8a03c1a05c52a8f78d19467ae0af8f3272da03365a618f95d7407035cd11667ce082cd691f7f0b1b99f3690d6d52dee5c00deceb11ce7eaf8c987ffaa998778bf7878dc584b1b51833731d547885cadf278e59cc2bf84d1fdd713f431ee749b9ede62856dbc30ab6f2f61116dd105bf75517995092bdfe07227851ad98faf96b2c1cde6a3b8a471e85dfec97b641d9f8724794f0441cfe8e4606b4de076f4bc66da71575557abd7d048f82c777bb221c6e5e1b64ce0a719f340c11615c8244e437d9b2e53da0893151ba1bb4f6594137a1ab3f28f6325c31565b858a3502f63679f479a277030bb4c5ed312851c475b8a80a890925d549c3906e3fe0420f72e4af755fbf8f6d168784f088c168e79087c05c1fadf38fde8650f196f286152870e0bcc7b7aafa1b09964c82250dac5d5a5f23bb333f7201e29971a53e810dcffd59e9b392cd8353118be202e790988f4a61229b89683bb7bc3748f9c6a32e56b367fcd7911fb4b0048fca060a4673fa8a981b1f9f58be8420c38b4f0e6440f0655f95c3ff83bc3d6b038ac723f668e49a402d137c9b84a6598c90e9e4b9cfcd7ec85cb3f0a321573e2dda2ca3d35ffe19c85eb791d60c53fa6ac187400209100def9a1985c090744b7414a9a79b27828a8c6ae31a1a63e3ddaf0496ced780d51b12f50d68ae7379213f2739bf0d73e4c472390c4aa71f07f4d458229e4b947066a8ade3b90d084489e50c281fd7fb49be242546524632ed2c00c6750396b09260bab24e93bb2805fc955664cb091b0e36bf4e7bbc045ae305e18f44c3975e079ec7d69b2d6a62ac1645607e60a09e520ac36d2d604887da004fa4c5983923a1a7560ed3dd51fa9b69aef7db7a00f260983223e4e533bf6f76d94415ed84a68692eea71d7fbd5e05c60dca5b6eb3dcd6224be38b8556be2ce280b6f6973dc0a27a01b5cba3f51ca5c5dfad448b33489e3df1a99e311fcf812096e59c526d5fa7364df6dba0d7f6522d492eebe68283c5c54a6b472f840a2e0274187cdfbb95bb6fa32214b9bce54837377d0c56833801e3b715479edd0eb8f5ccd2154f5d68c5bf2c6124b8db77070a7c013cc61b8e5da73c98b8e005c525122f6ba40b62971f4ca5dfd802d22570a73f45bd26cc199b430d52e57484b77016e4bfbd8e5b72485857f8b5fd2ce5b41117a4f90d38802184adfad1c560ce80f3daedf5f0a0efd5dcc071b9f58229ee4b8a45888eaadf7a123289677647499accaced957205f3e0155524e88c6aa28e8f00b26565b1077393a27638090778d354838733dffcecb6e840f85585fb578b3944b62b4bf4feae8bc6eade5d76dbaf6efd1021299e3c1fc2cac7a14fe93c43c55aa09705df7c05a5916eefae02062b266d66549fab226a76a536faabc11431b8bea9687ccb48d3bae2c948247cda97e1cb400069d715f087456450fbec92a6db944ec046ab27bb47f45016c05ca66f3d216f68d0e443aca9042c7631ace65fb7a413efc15ea0c94d2515c65a2f377d649e1a0e61f30719016509076295a3cc614a59ac15651055a34566d9ec6c877ee71892fec776e61a1fd713506b6864f8b9b2052d3db22ed4d2851d4f6beb90ab842ce2b4007f27642bd39f7e82c2e3ee92dec16004f483a8441521754dcbeeaef3558295657450b4f593263fc8682c24f4d68de4c82cfde2f94050907665929c6ddb79c431a11efc3a9e38782e0518f20cfbee0c7bb2a10554654b14de0c9c26614ed46508f2c8912d6a55429d94438973fd79cc1b20d526f62daf8eedeaa81212a420ccad03ceba332ecef45f963ce051b5a85b2c079d0a777e83b8d1db5e225edfe23ca85c7fd0b64aebc1bd07e46bb1f8ebf1714aaad873885ae9df086d96c63ebd4dbc490c0033f80dc733780b7f5a67f66dc861eebdcaaf24cd5e67927fb879b4842a5973f1da6d986467526bd8ecb3658a5d9a07e26abe5032465e38a5e01f56ec68253dfaa51591f4ec5f4de08c85f0d1fb2ea01eba94a13d3d7c326c0b0b01630bd44aaf16d990abf2e7362d11216b1a4fca33c41c409543fbf9110c7a8e38353b5c427e89e250fb4528975affe32df58d718074d63143ac3adcfad83cc4cf80fe8f1b1afc33f2951742bf29524dbe06e264a7b50030b7511ceba6602083477d9055601e435569f194045f2c20b9b15e791f4d7d68d4c5f70ec5d120a75cb7d85de5b5736286b45ef59987ba60489084389e9812cad712b5d1813f2a0dd94f1b14fc3261da4943c5cb38a0ec9999672e8c9f36404e8b2e56cf7d2f804b038bc0ee54a235ea586b663e7de09fa25f2c05a20bafb57abb0fd74b50a4d0a4cf33c4a009b31f0c79cf6968339435855fe5759843548831da6be81b93fb341ae917eeb4005bc3bbb02fb62dee5158b93bd1d36c326a5961527268e438608a74512adc4d0e6595998c38c14ca0dcac372fbd61c798dbd0d5e594616959ea644a9bf4a5e7f9dcca84e71559c16028c8ebfeceb3f9ffc7b727edff96a5459de42c37c6d4ed54d492a8142fecfc734be555fd60e9230d09b2eaeb18d515a21b3e30a99bc7f86542440993838dea6278a2de7c0654c9b5cebe6d345f9d6bc661fb368cbf8f3e0a1f994fff3bf2ca2bce345d216fbe652437e873dfed304d53cea9f71f6b31ebedd47c10e7360c21a538ad54c2e2740caa11e1d6fa78860ee3be7e4aad70d10381d5392581dfab5e184331c3586a61e1379ac8da53a9d953efa639c058b1402e618a6fcd9ae3c8a30f4021d9208e4d8f9ffdc2ab242c66b01cf9923577979a3ae9b02adbd0da5dadda3539d85b1c1983d0b7fad642be0090894c3129ac69ac9d85c38d24a6d618ad6e2982e913f4a106b2b9ce24597a5e011cc520ee45e5dbaeac1b7453b5486c7fe62db70086587576577565a08dbbc87de3e90ab26224be1985fbf01b7c6e57c9d9c1b060d017c2b54ecf683c76060cebdd34ea233deb1808e18f7075d8b6418aa40b73d2d51e919c1d0241efd2bf63d0c56c7a582cc0f2f3db66fc25db7e8fa691159e75018163f387cf534a12a847adafcc4f814741145dc6f316b7f0f3d408ee93d25b407830a7bff8074911d75e74a4a6f9a2638a9d57f4312c70f0ee9bd27ae5714eb72fa8de81deeb4df03a391698efb3ce17812d247e247ab1e0698ea2f93c9805d973ae7120ce2c5ae36996b293d642553229050c14b9fbdc28cf511f38392abde61c017f144358bdb7c3378bf406fd2e05badb87ce833fe3c06416d216d373eb796e59524763e97b6bb99c4cd033ecfb1a6f406de867543a9a6451ee1dc594180d884a7f484aa2c15f057d94363eb33ff8bf65532977a1973bf8d83b012dee13feb9ea7512373991f08059f4aa72f85de59fad62af54202f2b19cb7474173cd3b0c8e771597deae07dc11c3207a9fcbcf434d3feb0e5a8b07e252db419f68d80b7c49bac93d39ad2723fe8b056ad9c966cb9a9cadf4d3447e5f8ebc5ce6a41e72d9b0b4b4b29daabcbeade650e5c355a615d2cf71687611b3f545c5648ad7ed16c40dc0b042b357ed1d5c731df089b138ff4439ee59e88a5248272201cc6515b9c0cec8d82850ce1de001dcf882142b666714ced42640b7a2e0d664803cc7a480a23444a652bc72564bffcfe94d6f71a9d6ba51c902dde32e17505f15b0d20ce8751e873a7c309571ec277fdaa51f18b62379511f85416dd2c5e9e8f626b9f296e1ce7e2ce0f8dbfe14e4e2764455240d511b69ce70bbd7dfa9aa9209fc2987c35d699ae59ebf4d926bc4c80354c432df6842a53ae88f90060d4d022cc74f1745a68ed1e54defe854e5ebde830c0978001b68b15484a8f1bc1e67f8787b57f81109fc937c63a23d1416a2cd2be20beea618b6d4555424cff838018731451d2eae7f4f7045e6d3916829142528d298d85e1692ebbc0f9cbb08be045a77b1ea304dd2505387aa92b0d97ace12d7f781ea9fa378a3e10186ae8540f785596a0abd2192ec6f44b36c3613a7a9b0e325e9af2853ae7c0c57f18b95059cc4bb1a7f042ba9db4595c40d29b8e3baeebe921fa8b376dc0b28ee5b269e1dba678555a823359b67fa5ec26d60826cf94ac5066708c6191cc4f50d74108e2b66966e4ffe391acb9dbb493663f9a714a8cf2ad4f77bd3fec1489250fb250ecb24742492b899d3d1e1b13b3bcf1f67486b3b6cb306135f4b6fa67829e057735f22bca986f490419a6f81716741fea0326209dedf4a8bcd08894b575d6ba04d6d04bc7ff6f69461771fede4ff8369dc20a8bf6ca53e199053baf3fcfd93730a4af0a835bde8ee290e35aea66a5b7e41f52a8e0be2cbd7d3b41cc76ec76a17a0e15e5af4063001947260484919695a7549b5019271d2b1402bb33402eb55213af5c48ef1b64d8a390e00a144e98b2131a96ba146da7d8da951704ec2077fb797189c8ab8035ab6789e9c3ae596846629a758ef2fb8bc4b6c9b11177fc9d943ad536cc8a1c6acbf8908a3d7ba2918dcb0a75f5a0cf74a8079e6d0ef28f212eb3f2708d5065fb7cb60f797b3e80ae5165c5ff61cb2773c307e87c5fe8cf5bc57865e80a1a0ea80c0c86a9eefe49bf18c63963c610b72b74852eae544760f2b06834c02b09d56dfe95a0cc4c2a717da3a2f17b22a4cbe8380f83207d2cffbceaf055d71759d8009f521b14d1cb147d5903474e7b4445db4962dc6fa8c365c803f716a7d6f897ea73b915edea3dff5a50e6ae8fd45b7bb711f95e71547ca550ef80848362cf3352bccc2ce50bba1ed097962f479a734b516e874ebe492495026d9c908a39980fcd9baba5be2542d9ac16042b4a0176af72ae5d4513cb610c34d9249b19ff386b91502b3822d6ddb6752fd5007e21915b0471db7fed357b0269f587c1ca5fdbda4ce54b8dd771e455fb1e938212225edfe096c5624ee58aa25148a22c669cd6dd080c85e16045e864238f891730d0d93afd2b5316545e3b6b735654fb626e4688e2df2bc9efa0bc7ab3c155fe0a4abe1ffce574b21811fca2589e8724dfa38a78fb2685a35bbcef35af15387175223b3958dea6932426f8c2e3e13ef1b077051536841c743d1ea188675ec45579f40a6864163251d6fa99107c848859a73b0614231b7e77ba56254dae3bda1bca3f66d0521473dd88a763ca16f7d0e51a274a32332e86c3c1e8f24c46dc7e86360274243ebbea4dd730d1b805f367f898ed0d998202ea3d2afa4731e68701156e877dade9a39991b9a731c577ef22f64a1f712bb62ffe4af6ce7acc10166ba56e0bb8d72de3b8758045080cabd60ac5f905864d4a54ae3c28a00cc5dbcd2afdb8cb563806100973b4a5ea779cba0d8a9ad34067b1af034a411ea8112836dfcdfe6b1df051e49f29bd9529d1a10e74e832d5aa1bf5310057151dbbda46e1802f250caf21cc3056272a0e2051f4689d080fe9667e79f85e278ff77f7e41ceb51a7df3762a1162fc5ef951040c485a4079fd6781669c5ae29f45fe338154da7b3288182e160f8ef942323c01ac7d0d09de717b2440a2e16d19300f3b2b31a5298549b8cf752c854cd48698fd987620c41a4513461b14e727785bb51d2ac02120dd1d1cd38eb1b392cebeb47df601d8689fb77630749fdee7ca701c91261bb6527de1f35e7530b65c44f3e89bb03952983af00617bf25ca025a75dc06eac8b7d185647de3bd6b567705100b7d5b2f940f74cafc253c84621d50603d77236960beb10f2c8f0ece6efbce24bfc187596bacd6212947645db4d4994915018769fd292e73f162e719554033046f98c2cce83eb2a0b6a33c93ff3e5ad789e13b5a29cf606e28aa9fed1b47be3ea4e4a1b8a4c1b80fda3b97a7e04bde9f197633db437cf21253f2f7674aeec4e985a61194a3624b50e8dea13d2d27c7e77db42821e88a8436acf7fa6ea32db7cc884e3c4311df288693927bb671c0c9a3d6c9cc7c277a2fc2c35492bdb186f87117392038e3eeb1becd0d80eef2a8bc93149fad43f055a94122e7f5ae723e7f0562b368407099d1720e7feefb27b47d5b0326d50b76fe47602c710e0ad10c1050c143c0d960682620c1ecfd6b190f44ed6f5214e97b75a730c58dc61ac52caf39c62f16444477e1ebee6b5b1a027f59e595d1bd6e2ab066463c21f14506513d7ebd1411a7e2f3d423733579f3a0ed4e37fc0171227e38ba22b57c11840bd25b6bf33080b9b65cada8233f327e379be732567527c3f8cb7e27451d7a008131f42d2f7118c3f5d3bd40837924cd13fb0bbf8ca1399f26fe64a28ca2e124c7ac2d7938279b4ec45a96706a08961ec3d06e6f6035044c297740e58200a00a7bc7333b8d2192491147bbbe98b84387d8b3fb6d14c9a42ebe36f718fc68cdc68619b097f5c7f7952b33dd33a157c1c307bd4100023872effb69f09fcee2e6a879244286095d97bbe5fb9d2ccb17d71bb4aaa335b16151d5e8132c1b0d8e591c50406aa25898c046c2f1c176f0577132ed346ca79ebab3f93c27cd4b9ef5cc2b4a5cef9d455c2ac72eb51f156379295f510859d99c43aa3dfc8c2f437f7528bb4219d2406afb0d3002e5026621981336e76fed9a4371bff77d5043a085da2f8434150973fa52ed4c7590ae393e3ff9fd04aa626c56936333bd654714d6d5b52d90ecc58470346519b9db321121160161398fa2d361a3e02df5bd46529330f85266404f5a28ecce6c6a6ae864dbf2497181a98829c2ba5f21dbdc20615ac80efd28db7c9fbc70a3a0a2c7f809f01adce85cf3304520950bf909be98b035c28bd1610e25cc9376c1f8853b8934887554d4477567658708287bf7abf7cd85217fdce06eab32e219e54b6eeec0a11595d786043fe0152d8330b3350c25d876252e78e4be2fa1a05feaf1b9a2778708d637c44b3419e6aee0ea54c2d13dcd70d7fa208212b844493d94d4c2c15c5d4757acd1dea455fe8cacf46dbfbb592f19076e77293d7f8a17a3f90a782bad76f42af4f04a8dac6730d1ebb03ac8927ff958bfc7fbdcb902ad71cdf71065569789dca5806d00402b281e2e700a01828e78d553b110dcd8ff57ce367e0b5e4299fccc67ee5bb2ce47e9940201dce30e425d747cc65ac4f41f1a627fc7066daa7af380714e2816f0d8a13c05ca36482b1cbef6aa357fd70556c8efe8051b47e79534397f30475916b56cb0c39e5119bc7c6b7e6dc16798a7b836498dd4966a62eddae871e2a22dbbfac9b3ee2ab185ac841eec6b202a6c0d7b1edc617e1dad8ce62e08333e94adc51cbb3891ec9264d630e8a8c7226d7dbb39e8e349a3a82db67ff8ac38cddabfee3eb7f41d5ba42312a7af327685c7af295e17b5860bf1c758cb8a4c8341a5b86eab6f44d43551607344784454fa2d323076b4c172ca7d263f7da8464ade406945a2cd277c5cd2c32dbcedf1a4ffbbb6958677a5126af030efbf524d14d1f3efdfa29d1a67512a648e5be1c00c1b9646b55120be0d4b0ca2b1a9afe47ec4da064d60743f0d37e31b9d47d6201842b64409eb2c88a033a119330ec8c8cb6a519e1df82a48c4b7c68602423a5576c4f217e8ec4146dec7d3b0d946e122e39f0852ca352f31faf096182861e66c23b9432bf437d5fbbec8aac0d5ad6f7d16444525c9c33e6e9639f7a091b37c787ee29701b851331acfacf7f9bd15f156ba7c89597b060e07807a74d0a25fe4ee6e6189533d3751f2e41172d3ed006b37ad5698328693a9bf34f198cc846568193886535130204248c493d77068e9539027ae4b8b433fb5d71cd04a3e945392d10773db91e2cd8e01eb58fa720aef0dc2e9dbd39406a13ec5aed93e459ea475e2f894056f8927fe9f969aded2756675977882cbcb57e9faa4404712b3aebbf5183e1c6165942825c7001fef70b9404ad2b8aada8de06c90571ae10548c3ed0afbab19b1559fefcdfffb595e5c95e7365e429a1dec73642689f635fb6e948cd4051589caf7aaa3ba54a9482f9dd187113bc3de23ba012e69abc131a1c71694c9ca505378dc9af66a7d67e7a58a562bab0e5837b3d114e747cdf013938e8d9ae0107b71954a3453cff4bf38c374f20fe28264c6d7b8121a8148a4ebb69d992a93176ca2c60a65611e82e7450fb7226bb1bdb37bc8838dacf2cf4ff27e07139bff4c366cb2aeef21f95a95e73fec7607c69da87914c1d482c3cb0f5d7213f2242cba5bc4227fbaa64314aab11aec2ad910c2b313f1778c545babb9599895f859c16d0fcb44a04c5594e58cdda5d4fab80e8ab166c92ea4919415f424ff0cd3afaa629dc01e217b3dddba6f9d87ea0f0f15b618d124e64f6e224dfedf16d4f65f794ea3634df13c218d4287c2673e8d87073e5a048611ad1768db46f55b9c5854b825535f96f86ca7cd3733c59ba93a497a652f7e3af7e72e1846f4ad887be4438cb8ef29378a8c32838aec2ccb3ded1601ae7a69bebb289c5d4a5fe8e1eec1665fd114a1adb0bf649eaf5bab2badd7f35329c613da36ffb312a0ed65519364ca1a0d1616d8fe02e79793594f18ed3fbf5cbdb414b2697f6e614e9ead625d505bd92ce3ce34d4370869e674bb13a164865adf5f698c3403d5c678bfa71fe8ad3081c803efc3ea8b1fa10dd34a44e3f9d31da66a86b3ff01d117782cef14065a8b754d4639c8492181a2d115193a14d771e471e2bc3c20400729c515ec5e43742781866b1bcb0a2d1e40458452f3898d7f8e956bf2b57a536d7f3eb5240258883642514efe5cb00c102e75775ff4fb2380cefee638b7826377ec4e446928cad528ba8a8976dce9f4450161bc5cb66c354a37f1292f6d432029de10e4ee09a5bcb85bca99919b7ceb108ceac5cb48bf0d929ee639990e798ded73a22e8b81d05fef6674e656d44093536f032c98df6fce782307f3d8efb9be2259ec6fd968c56c7fca557e7ff7b9e24e9ebb959a18e1fc769f9872125dd3762179d8b0e25d7306c5d715d9920e2dbf1b544ce0c6d30d8c012d7238a47e507cd38271b3cd59f34f4368968c040eb62f33196dfe68b6ebb5ac876b91d0649a6fcf11ba7cd0fae7138edda8d0977a6bfafa5e44fdfbdb9e446249ed33c217206b5ae9665d26fb77f81a052fd38356b624f1014b593e09bddfa0902c0d5a2f0f01262f8dfa7a0c7271545fd990d96bb0e17ffe872e9608c6e2d7ec75abcf5467cf260bca6388e43a824d3981f03914b27990fff5b40bd0b73213d14a16ad99dc398a7e8928dfdc407ab3988b6aa808cf3dfa14dc4abee08f2f7114968582cf0c9efb01dfe4eb14147d21d3eccabdb497d4027d51989972ae4d4f96cd04670ce755480091739f2927b9aeed49a1387f442771577eab6f920859dfbff2d21883ed858246c4d5683c2ef0849827e5da790a351d62b755452fa120804d7a4387b5df8c45dcf7c4d3ed5df158933c7aa377aa65fbd6e7ee2d844edc96105689c327bec882bc0b76165621b2f51cf4ebe561b6af1656f5ccd0ba6b14507d4d7384b9f99a05b183eca05abdcb5257361b2bfa841ceed0748d83643fa4e0a1f49f3e2b716274962613e553e792d381b1c8164f6002c96937fc1874aff365d3e228f835e7b7d37c44f6f59cf2fce6bf96ed364ce909380508aa86550f36eb45a976dc530602817b3ee7f554c2b8f1aa9e5c3a4d1cff9e2f34d61e6d63c592eaf898b158ab15e0f6aa0d0e473c008f2763c2f955691bd9fc91b0dd519d3b95cedf88bc4bcf1afaff96677ae721124bc03000ffdc5e3bc09a936dbe4b26fff763bd05f4435d9d6c3fbb853cf646729430df769d658c3d56f7e0d346712fbaeb818bfc113a09bc2dd1dc82d76aa918e987eaf232952d9286911b11bec73f80373dd0e47cc64804184dd5f9655ecc5b5f8c55077ba09a8a006019afb418696e7d76fdf19804a3c2e3ec287717f1e0dd10c4ab62d347d7fface8716af1cddf1cf965c78eea030b0de41a38df73a58a39032c7d4807309d27ca744bda5b87bbc3cecb1913eb6959701f98ef526051b5dfa09ccd0eb3bc1f0f7e825ff703a74c0c4764594af413743385a5026d67bad07ea7c292e8154d7535c4a4e5e9ce687e3d1466f5979e49dd05c877595701a80660e66df5e2458718cd7b51eed3fbf5ae2e6bfc188878997309a3bea3fe68e45656644828328a04f4d65cf4bb95d8453200c54aa01377f4826b91f3511ad12d50416cbc40e611acfda691c9e2e2875a4433b6f75eea456e72276b186bbf5d49ac54a5fc0fc09893b6e41e54abede2e65152faa05b241378f9f12c02b38192d7670332af0c005354233d7771060f45ee3a225a01be0eda73c5ccc8057db6d37c66603f21d7a67ce7418ea3a702cd2ad8ac5d0ccc90a125fd0311a19df6348784c297a56bc73507108ce34b3e9900bf98dd29b0e5a563af253ad1282e8fb927f417c4681725ce6c378c952ec643229554bd54444f100033c9e8e713a0f8324524f54a15ef8d096f0f32c8ff3402f5540a9e3e0557e790c6df7c2d2b0a527f5c0eba8e219f01618f6f072df0ebca138c0d4c5fd100a2fe4edc18ae7c979bfd894468955b240f10007801c960ca39ef591377701fe933f5b1447fba4e67c513d0fbca9e0899450c4bb5db88ee3e86eac98afec008910e030f96ca70389363aaa56dc25099a749c5398122baac48179f2c5bb91877dad6ee9519d72e42a63011dc116a6ef5bf4c860c787fddab171a0bf6865ed70550850731231374822029de1ce6c703909648020e063469dedaa995dee97fcdf68e89f5adb9d40e0ee599cf7a77966174203ebe1f03c4d7126c47244fab29555989b89463b64bc5287f021647ae1fb320174ed33d26500e7a99d4935a9b7a01bfeca210d908e0cad2025f1c7ca5fb3d3760c7a8de0c4ad05b5d940fd74569eb7b58b705c57d12459419b847e594641e7885f5961c1c69c38e4e27f5a7cf53e1caff8cd8416ae48a237ffaedcd37c6dbfd7f6234777526b5c5d92b9203a67f8bb642c2c22a45214c162382fe3b421389b71f87233c35334ebc194f55727ba37c71852e9e7bca6c6a55788ae8c5292879c56bea9a99ce71a35210387f1faaa09ad9dcc5b71eb56767f2a3639adb8d137fb05bec9a3e64155c8824044d4ea505de4004b946c4e02b0c82221218ff3167371e99208f37db7782b593c75e363d35278a1ce9c2660ac3443258537f065e4f0e5054ba94bfad7643529eeeff0cc2be3793424d18dd3ba35cd612af3a123f322bb54fd4b8305caafa47e6b086e33c186de1f14fef3fd109d86e15e4323e917ec143b267c5f9527be604b633b91d7d7845135d2ccc0aeac805c28f8bffc56f7350a6b8b8d9a383924c3d2c88855e8d2ce1b5257e0192c180d3fb551f9c064d1f52c9d20c5b70c707b179c7544bfd6c342540e44d1ecf242c30a1770d18ddfbcd57e5e8c07c8d91c283d35d23a322917d77f82d0716372d5463ab6290b004df8e9cf4f3118f6bb9700fa7b3e2b65d80aa540b18b8d550101e11e203c2c00d39ae614468253d598fecff4d3cca1c42c43c2e92237efac53f6afd86cba72c53080ac9eedd95ee2656cba0194959d71d98cf233a8710bc1d558fc8db84a6a80c34e4314fb49fb7f74f1cea9c468bee550a03996ab3a1fe80bbddc0a543710b558e1b84296170a4f5ad306829fb85f32347a540c14186fbd9d4fdd15b83d5aae7039ef92e778065dcf902214b14d79089b3830f684f9e2ae6914f4a3fd3c50714e96a1f6c0b3c57ab7854d662a3fd4e0bd804ded915ab7179207149e19594705f2cdc18cb5ff97a62e9f32fcf66caa4e54171cd11d39167ef9628b54c3123250f337bd006cfd2e74c5103971c414cbded144d45a3795e01c96d918b341691f5ebe109529b338bdd87809421531fb6ea6bc640d1bc20e269eae2ae10c96f990dbd3ada50b42c3c854d90701f08aa32e03bc4df7086e5194d23e72dd765074ceb594a685ea5458a4a9dd10b73e941c2898f0ecfb610520905f3cfc03f94e0988c5160c4cc361e946f87703305892530beac459ea4037f628d9c7cf0549c5b99e9e5441aae6ee8010e8d0ee7c7df26a4fba1054a5b84f6bcaff159b4492669c87d72afe1b6051f840da1f4b3a2849ae87bcc3b9b2b6b019cf88889c6febf4412873c3ddd85fb46a758a0388b96206eed91e84408cde5cd9bf23afc1b54eddbb8032a9dacf074920c520e3b78e4e9959ae9dc5fe5d825c2b7d5d48d42a376f594819a90154e72a1d5d14c5fb086e6e5f805caafbd82fd09bae1da26e3f08ca168e09ba1ad9f1bafe0e9a1f3396f6825b9245ba2ab73418454acbabef9df70fb22a207fc519db7e37f078dd5e1a610b92a4b4906b644bd9473ebe899eeaa4e305935e97a7e827acb4ab0c6bc1992f86490d68e7e214c8542765ab89726d351a308295f61bc3b33a9dfbcab856dd69c9b26ac9d396c3e5c971366b45e13dc7212d7fd09c1fe4587bb2c57940a7cde15a6ca86c211109f007f5960183e50612231aafd39f026be22f3f24ba4f214a805d7af6d41bde3be6e65d34be34d467d8ec01eefda7fa125dd36a0d1e8f185996957e2f69ef40f27932660c5481efc793358f67f1668d68ca285a0a447f1a66a6ba0b098291192b8c008168a776332a19c889bcd3b8f1081e6b65af1e796650927446d55112d190f479ede719b23f85ffd9b9cb14256739c64de7972a38b036c61eeca26139704e1f50354a3125ffdc565eec5f9011f06875f04c0d9fee9b59e08d124bdfd07895bea5bb8fdc395c4703bb218cf59e547cd3ab66983b5c307da41203cda8c149e2eabcccf5821f50d180fbb5186152a38242d00686849a807779fd2a0f78dd75c1fd61d7c22f212af14755fbd72d59bdb2e4cc5a7d47d100a99472550b1736acd4ec06466c19d09762e17a71d36125428cbaccea69f6787d2fb720f29b6db196f1648207b620d4ccb9a255d12f06057540cceef203d2dd2396632c6b215688f6d6d00c8cc1088962827f6dc6ba9dde7d5e568b869835916400a07e011c809ca58d2a5d5ee66d064c260cb4fe460120745f4ebd7fda17dd377894e78befd355be4e995c06279bf694d8fc31b2fce2924c6a52fd04e617c8eb075687ab08bcc0523ab10f9ad3dadf744b8a404575c20171b7818f7372e06a9287d6bcfd5af00971d363c634f301b28c7b4b70501967ca6a5b484bf7c21b26e2e6d14c372457cc6f4d7e8f9e25376716316122cd8c92b5666eff6733bce313f1834c7ea93624b9285c905f1e16ce0e0ca38340b8f829bbe5349b010276bdc663a0ae0217f5d80dd7b92d390887893480b34a3e6222770c0889d5d9b0c3dace2445755b60aa78a4f3fc248998f61e1e25ee6b15819f0921109dcadbcdef172cf1827a7f22cdf9ec39d62fd38edbaa9114e52819085b745606dd62a548dcf1fb979f0612aa2e8d35d55eb5d063966edda9d348ad3da71852dc103835c491076e1f245a0bb50ceefbad27cde25b96b229e4bb0e1d529eaa5b02ade968062ba43315060f0b1707083dda9a2f82963c079072ed87154598c75b9404567ce63cf4d6ff0c3237a0f2a8427e6d397255812128c49ad2f47fb572acd35c22452f758c949b33f9b8c867e3c59860d1901e92e8d808a7300b1c2e3feea483e072e15b30d75e9060f44f0bbaecd8a7a6dd7994a4bd4ab954ae130003159d135ece477da2162ad5e9c2ad917c8bae7d93afba4757cb90a372efc032a77ffda02e6f784196d5f09b31d7ca3a31496fa7a74c581a401ace0cf9bae88c4e724e49ad2411c5ec7aec12df84c13aebfa9a37b945e3b0d666943831f5f3f27476068a363469e28b4a60529b75969569d4190a18d708b1329fb2ab5c13ba2580e30f1078b90672ec751e1b9e08f1585743774487d6a4861e3f006b61b327fd973bc99ef875a94352b2b698ac3ef1c40adb8fa61c90926023d50c96b6d623d425d90842ad3e81de768352be278d3ed048b5bd21bbe5e0aa2d625e069753e2157da0bce06eb03311536b9c0ed875dd5d8f6db6e8eb5e011614c58011dbe08b5f6a0aab38f6f69ba52f7c13c8aaf6a835e9ba97266673970e5fc8e8eb7d2ef694f52e3f56e49e5166979efc8a9374bd7a758b0b5385f7fbd9da1c26527a4aadd9cb0310afb82e55e88c634fabda43638f3ed07c0d6daac2b81dba0a12c60d94b8273e3b0e67515a4620215984956b4270d344f679dfce6e866d90b6edc89f79b07b5c274cdf388978a064b24a917c7716952402ed3f6c3f2e08fcb22da581ec7eb762b3ef7cfe7c33cb329f0c563822612a157cc4cdc21a7f4d9bad8491356057eeff2cdbb55509ed3ee4576ac821afaf5c217383e819905d73dd98120f96cf60170aedcc768ee8d980bcac76cb6c415906106a13282d432cfd2938276c015db17d6c0e2f6e1fab6956e9399f75ed3f146d945d922844e9f4c41a825a27530ff61e757763b1c2f561d572f149ac4b2b585ed68c1d13a1f6ca05f7cc3466c95eee85666f78aaf7c96f37609c2a813e69d73e88023e8b45063c8c735a3274af19d29fc98f53b3ff3b18a1f88fa23a1417716af6766bb13db3f57d90e87f7be7b85e3c8482296f5d932b9e56e20f70f82b76cc1fbdf1c9a38b3d21788befd222e368cd85ab99a4f86516d257649b0c783366d39efac647fc940c15b5f05b61fb74353f161be6cec16cc3e07bd6c0b3a41e08572fc8473056a79cfa359be333aa5e1e3294dda20478dbd601583d89a0acd41b243bc3444e649abb5f1fb8e95d7bd63f023ddad62dda8ab1a1fe898b608ed83fa1b6352c67b8940e1104b1267379fe9b922d4a1dab3b1cf832c4e55199daf036e0c1ca9cbcd83a9ebb1c19e04c51f8be6bab6e9a2b425c833f5679b1a3071b1268cd8341fc97e85e156f02eb1e3e68de04810bba7bfe6bee28d24b13e2d3396a7b9ffa97b6107e812c33d6a7f5839986c2394894d5083c7ee6c8cf5a1eb091254e8e232bf35b2aa935638c660330de287c305a6631c76718138d5bea69ee03f9345c7583ec02cb5ac5a4c967f746f12d7c22bf8bcb23ef43ad7a7dee7e9fe2c68706357ccba5ae716a8df931e07d22ee4fd16ab9064880decf85ce0e837ded84ab5d960c15d189e6cd581cade0aeef376ba9ea3b7052ffb13eac0bef7f72e27139b2b815ed1205cd7878c11aece5377b1ba0538cac2ecc1e7a7d1aea3cc07c1159d0c79d80b1edfce560eb84acb50ca44be321f51e7d4c2ddefab51c8246f982e9a1bbc6ac7c961dade4b6f917a09441cdbe3a3d97ff73e34f6a46fc30a7a735f0a05c04456e6d1a12984bd59ae18d6c4083376c59e4ea8ea760067234116d9e5bab428685fdeaa73d44217bd70139da3e53c043fd76febbf1e07024a8d79f8b1e2a188af740af3ad2bc2bfb893e23275dd6f7f2587e88313fb6884506db09eec931703bc91617cdc26fe09126b35bbd74aa0c5c8bd4afc2c52342c4f153a186d6b0d90cd793b0948a0826787155002130a08f6d20eeb72abc17b18445559ba548713cd7609cf7728f019f29583ae0a93cdeb899c02d6733a8c38d8e22eef87e61a8cebb040f196ea9693cf8a9f2980547b5d8c4b4e72aea69b8960b6d1aa56be03cae2ada48751ece70467e1f636a5f06c9840c02be84e32269b3e5e6e296e191ab23333d05a8309d3d936965a8458de3a437ce2fd171463337ea927f5e1d46d91d56d77ac8f3093381dc45236524f50e0d73a461f7816c8ab499cec37c6ce198e03b6f5bea90e0b7c13f57136b0ae19a49f0b764f30a4bdc3c560770d90a602d4a9330b30a9e934c875779f7019ac476271db00daabab5de8f8ffcb711dca9f501823cf03816c3395cf7891d95ea265d454d20268026070bd5755c469a91327dd1a87d13d4e3834297aa22c0bfdaea475aa195faf4e08639719334d0316e0d8cd8265b9e28acdbccab9359897d7c3ea6769e0f13aa36db31e18f6e88eeff0b890038f34644659d7f86641d4d0e9e98d6241c6f07cba7a66e884728a180c1b3c70dee9c6054148401f91bbd3bf8e763f38bdecd97d33cf151a2970b8aba398ee4d66b4b435aafab11a1a2bfff67bd555be3822c3c1864fbba66c95064df65fa7c4f1eb57b8c3973979def9e86364cef2178c6991fc5565e9e3588b494da03add56e0dbfacc11b0d1fec7fff35837f6bb6e81a4a520d8ef33081232f302d8f42a4df39a9b582be23fd0e468ee6aecf9f64ff2d26962a2d0bfebbf4ee4f8b95dbbbca46f91f1d80fde24b50170a717e53bbee462071c0d833238b0090eca1d555cb8ef29cfe5981ca5ae8db13b9c7d8c71afb9fed81d63812c2449079e6b501cc02797efcec0bde1c1eceaf492a1856e8594b2c40bfede2a5d5fc0771acd02a279412605a94b359051467a71ca67998561550f76461ef2461749ab1d14a7ac2add5ab22bede3ea86e4e0608431092b83ea1289e386a6fe0810f15f5f4bfca48ce6c524bc5ed636340be7c88227b1a98da872f68457d61397d72f114758dae037082b009c815409ff45f74a43e25c795e66f506138ae1ff522700ee6caee4e9e6947670c1e65c4e2ae8019ce641e1f17bca361e25655d9ec3c69fde184b9fe8ba370bcdf9cf60c407feb10b8ff1189760ab089cd48ff62209c7a07a954d682bc0a74516993fe33f6d85fa925efc31fc8d884665ede5da5a9d8ded46096d010bc695471124bfaaea3cddd85987ebdce0c1f1bcb5f99e37074da0de5dac7ca4c0e1b4eedde2c78acce7124b68d961db145a8d17c562a2aa6ea2cd51bc6b058e516d1e614c7ccfc5cb6188b4adef1453e773a6def669d0e7fdbaea1574d9ccd95d9d70201876760ce041f9f356cc34f545be90526a4a3cfd66ec395291dafae5ecc1a949bb4c689debaf5d3f53a7cbc1178d008988c166f03379e455e780fc3e19197439d255977032182bb16f62bea23b83f24b70d1a447ec378cf7230c93764bacec03b44e0d5b17e3b0f4564e1e67a9882a8eb0ea5f94e09bba1dad9790cef8e6d16f0a18c996b424d98043c3dd2c27072a139f5f75a44a029887feb3fe03d9c912081334992bcaac26d0e5ac5891fe2c7fa5300b971d5b6cf847cab5a5a408a0e96b3451396cdfc387cc9cf10a514e8d0911ef673057f0402b5c6a40ccfaf95e28d230c3b3b030ba9700f8d35914328b7eecffe6be2b54cf658a227d448e2ff27d8574c2c2c4734db0e2a27cfe794409a358b9fa12ca96dc60af619e3458e7c858a9a2dba422448c6599b0ad5c15fdd4de830220fe3f0f203bfea0ecefddab5d04dedcb2234f421e947554dde5588e9af86f3bbe135665c23c1e927f748ce98f951472515d2818f884396e871a5232cb04d39469ce066369ad06cf98343ca26b0203b7e94534e1e6503b3fea5e9d6ad1d5d5865b607f4344d5a945273e0062e753a604c67b76aa7e7e91e509ffd11edecf94f453dcec755d9bd6f771297c3b0cb04c2806a5d58d14050c53592fbe1597e3e7403258d13bf41ce3b5f86caa5c8b7b52000e4a8aa89ff8465ca08548ab1460c3e2de56dc36aaf4d69bf9e28eea6b40d1f0abccb96bef566d08c3e40c4cbd2ff87319ab24d8039a90f31f4da7cb680395d0d02fc2c7ec66d57810104f3630f5ca7e553b1fc08438f21e718edee7ec2e053d2c48d1833028cd0ae2e70a22e1bce8b23a599b6266415da8f531e2ab532e499d15b413c786a71d6d9369b73fbfe172dda01242553c9fb9d2fd257534aaf740ac33b9398b0189b4322171399f1fcaedfbd1ff6d7424dc89353ca20508b4af8ebbef67fc9acf284bdb2721112b272494067a04cf1a8e4e1d25170a37fe505bb6cd3e26c3a7ecd4f91cc2adb555fb9340737ab6cddaf95c4f680c12ab0bbebe3dab08d966939880170e3c171e5b88d7737397748745de5c0a8fc39022826d9c49415b21c9a1f7c7a0a51ec09e99250ae886726fddea231051f1ed2aa0bc3f3427062d9afb35b1ab288b0627c07952f64fd4fe576dd7dfd3c7a8f21ee3217c5bcdc8529712c068dd26c50056d9591a302414d202aac04f8b29236243a0c21b16b0fd58dad7a6b4873cb6a82ad4618aec11237aa3dd8f943e754366d4a67674ba4428d6735f49e92b018cc8ea7f7d386bf89b439d019ea1b0aaf1b09477eaa0aa7591f788cb0e479086c2f0af18e22c9be3bb8d9b54e9291ea6994226581b9b730ecde828bc496e8dbd7716a6576d6a5ee3a07b50df65e6bf979d8d539f41ed4eaccef6a6397d7776e64ffd8e426ac9ee0866505aecacbba8ca161e314beb0c1a36e72761af366bb52b29b81fe314aafb308004bf7a7c562bb8c4b7b91a2481607aabe6e6e132680842956b04550d9d304d51a241d2e329fc36a2a4e3f132a693667fd146e1651a93ade9d65769040fb11ff745c02a93a5c8b99cddfb757a2265385f2727529c5b9cb4e64d7ff0d62546e7c064334e91193a5f79450f1445b7f683b04a04aba601729303eb557126f22a66b2beb664fceb6f36df9d181e921e10255b11481a2212af0e2793851f2e78fa041c76a4ebcc41338eeeb3ccb87d89784997a8078f31c74d0a04248801a61c394089e95ad28ff51478c1fdf8a24a79e805f939647e8a6c50a5aead91e8a4090b25dc16d0309309a8fe5c3c8179910d77ddc409a465e2a8d4646268345cf78c68b93898f9139f6a43f65a4a2fe151548b2a49eda7bb42f6433ea3ebc2e4ba959c45d2e4e242626501925c46bcfc09f4325a127dd90a499b82624e8e009328ab3618892eaaf66f7f2975e846b2bc20305b2b437e6f75b5533aa4ec8e83e31f9e735c9c8641dfcdd5788a619371598abe291389adeef627e55dc731c5ae6440a8de4c9aca1701c2fb7b3f040dcedbf683cdec97615217ef868c99c2a42876620fc2fdeacba9ba53c0d82db3c2059ebcbc1b528dee8fa22bc2a207a7b5962cc0fea2e1bab1ddbd6bdf0f630adaaed76c75275f5c79f0001d3c60d74b12883e7a6a76865bffcf5c0b93ed5ae22251951257ac9b534e3e3baf88a3914ba5f123a49150b8ef7ba6356740b547f8af16f92549f2cd0e311aed5d0152ff90b3b24a9ffd66a72882bac157ade0fc66be3d10688ea2ccb7149a9893a8b9f1ddd709e025dde4d9cb664eafd1747b737983e397638d771bbecefeb4fa7f7e264e25c629e0e4ade0f8f884955605a5a6cc0516ef8774d32611f0440d5529395336ba31896f295a14c21e16fcade0bf28e847565d4995302c5b260b90a11500112bfcfc026826093954775699d9f3f2d33f1759a33721f1d0b4e665a5c00d482b8a07584646c9a43af073c67a8252f2d99f3b7b2f669afbd347676750befbc3c57819f418df699364693d296b38551a604dec6754f0aeac7787cb46433b0f6bb5c3a872c5982eab4f9dae687abe51bea9170f336ca6adb75003692bf6388d509d8f3255bd78e24d860ef78d1fb8bb0de1d8b61887cd9d404290a225a451aee28c11f14d98227a64f01212cfd7476a572f59362b5be161d95a852463c8f649cf5697537815f95e3cb5086cdc81f1a5f84e865422c651bbe981555bf8d86934abd499dfaf3c2232373d081ed0874905912a4cec3b4ab521b446a408a0ce8e5eafe5a34e169ee53063e5aadba537f9fd1608c01d5758b8e3b0c1d27fbfe2fe23b3e24945e894f2fb4f795e13703d245aac55bf370031154ed3d8726e19463539e2da3196625a6a4b8c259218b32772d749c41e6631ada7cf61591b39b108fdaaf68d2fd8558a863a98081c424ee971226193f19a9bb4684f034ac4a0f4a16c5d5afd84508a944fef0d7847b8a7e339ca41f2cae595e5a6a493ce92ac5219459f646424c93999aa54b1d3c2575330223f258348f63e461b9254548ce714c669714e2889ad613cc735a80f46c0b3354648dd6cd514c2e83aa60481e5accb7a548d1d3dd928ca061665970498f73c3b42272a2b18ecd577e49efcfa1869c6256a4149c651c0988c8f294a077d47012b541f3ff6ee7f2ec6f69bcf1d110b50ed6199380208cdb2ddf1c0705cb280b693bf7600f70a80ceb1066136338ed218eb21c5045a7c6242d8df0b5a12abdfbc04a0c5923695256c9bff90245e08c7c71fc54245221f4f7fba7e2caab219963176d344156f5aaa44fcb51656d51fec13a4888829782a8e2462c4f08d17d0ea580d508a75689efe61b6c9a161fb8bb0092c133d1b9ccef767b2567f9d0c5c6628efd8d16c24c19f40bc498191452b4d119ebe317a39e0560a3073927bb46c40b33b1c77751cb9ee1d09a79399a6153dc51587adaaa406b6d9bac5e9d44b50794a572922cff41581939769d95c50e00b7d766053d590278f85a5a2e049dbc3fb63546dfbb4144b7cd36cd8e880418e3cb199d05d0821deb2e4e3c09e90fab9b3bf4a46732c67d3eb9e00c50bb48daf5dff1b03204991a80f675348399a01a88c53141c684122584200fba440ef2017830ff17706e1b5c1809bb625fdfed2db329d0669afac7891209c4653e64c62876b161987ffbbf9c5f2d40df06a1b723e2c8db88018e29ec1275d903c65f83375beebf8c6651459346804d60c4fae27a35117dabcc943611d071c4ec36b684c4e88fb97555ea6e583d8387950760beaa8c427474f354d3030015709741cfaf54f775267541d31e547ecd20b4d1e12d3d680cd4ada5fe086a1a1e32765dd1136495c5d1ca047e74ec294a05b4b7196f1e065eec3e695e1de9a74545051294a8a32d7647f2abd8501f47d64393ffcf8d8b2861c8341dca91c573fff720eee601b5470317badac677912788d67d9d30fda01d89dfe5d06c8289de45a15b1713c5f84fbcf1dea8525ed54497be4472e8b12452281646419c597e4b9c8df57345852b95874860adfce6e8e1e2a4daf49a1725b2cabe01b37cd11b6d0e25ad748cd15149ead5063a46efa5a3490ea3ab3b25ca84a301ac49015b008bef386db32697e5ef36b501ab787f5f8bbe4ffeea6986a640032aa9c3f027747bc1e0194d47c0281d9b119ba34922e2389376dd68563baf8d150b91f7eb96d15ac5a77eb371bf0af4fd2d3a4c7c9c4f0411fb4ef0ab9a8d5a0d034ca6c9ff6c39cd8638d69e0b5c41dc5a46d1db8d390d5d22f0351cee83fe936f9c5f53cb1fdfb7b5796738a1556e18466aab0b784f3180e21ac7f603b655af59f8904fcc7234c97bb38002ac8cc6003176716158277f9ed499e6fa92dda0b5f1c3c32b1943bd34471378a75d1256c1abc442d95bdf2a6b226e1e0395a1de01cffdad7913cda60b59ad91e4c51f1e11faf14a5fb7ef11d346375ce426859c219b89575ac8e41dc36ec19ec8436a06712f110380e85b4fdb4986719564bc06abebb804c45b458c79be5fefdf0cae646debdf19c379de0d251fd051e60ca4ceed66a39fb036d58d1ce5f7e479518d05ef14c45a924240ec8b956693f79e684a5442896103cd35e0460d2546d95982732bfaf509bcd367f85b3d3a795367d50612a1c2cca53aa2bbe27bc3b7f278906be681b28c5e09a7cf2f36ec156a047617b84c1017c6e8d1346406f444dcdc35c9bc23ef8a9830b92e6d37e618d27d2cb2d37b2f739cd2423a78225ff59e7ad0654206758620b9724202001571130fcc2950a27d905ede37e4b1d283f4db6a5f6a01954d2530ac02f00d10b696e33659540dbe9ef688b90d233ccd38a3850e9ccfbeb0a89f3215c77582c748f3bbb65aba41a3ea00eb76ec69da8ba2d22f65667e652451e8e3ee32c8e6bcdad011bdc0f2d9522f4dc5f96bb727b8da065b619d5e861ff4078151b7a87350b1d854dcfb21eca93d2afb16cead3d013f8003997f0b798de3501692ed4d4184da2681f5eda64daae81d84fdf6ad32f159358787bc53a4ab4d7f3d3a4d005478bdcae6f74e0e2ea64dee20a40dd537d7091ba0f09a75f12248774529034fc586ebd2834a3ca096cdc493d3f09c070c02847951684e94e8c97502c84f1d3429712c8cd55bea31b10ed188ef0bbd95077f4d714ba05db3530a24688c509e2f9b93dc7b1e18d3088c577f967e9db343214de2b9d8014cbfc91f69758eff74ecf48742b49c574393c7973f409615516ae1d7b8a42d7ddfd47381280f0bdd1893352719af9b51d302937b298c36859c9b28e7ad70c97705435bee4ef15428edf7c8b192a279556ef196cb6baac09bb7328691fbc343d8355b5838ba85c745901be6a0fb35d22dfd8cc24e925e26c09fe4f214bfd9807fc5508519e08b35233c793d04ac25a4ab784769e5af87c2a3ee1a9997c120eb23ceb33b2fd8165af4227efa7c07eb507da266c042494aaf15305bbd5e9ba2a0266cff13303605b5759437a83239d87fbb59b66ec7ccb2540457bc60df7f4981b950253fd8955ea7baf6c3e0064b14d7e6c9b2003d1a28fe479b3c2ced4da9f44655fa6ef5b457684bd7c8508b0164254bed617a9c16ef34a9ce56b54c9f81972c91f0a47d37d51848693541cda6c712763f0c3d9d6e4bdd59b8f3124c83c2c1ce27c2dc97c3df7a52bc2e446aa073af67ea070536433e0b47c2bf8c41c17c129a9849c2a35d10b3580cd865b0dcb14a5791b348510c4ddc89499f5782693ad5308fd3a871a69eeade05adbb2113fd99ab381a0e2cc9eb6ee06eb3d1f6a1099117c8d7679ba9ce86b8ab3b6df06ae541539d3b94a4b592f8199964c34f8e71374aa3bc8f6d76e503086204649ddc37e02d7a14e5dd60157f1524bae75cd98e8776deaa6347c42e558c2ade134e00000000010800000000000000000000080000000000000000000000000000000000000000000000000000004000000000000000000000000f00000000000000000000000400000000000000000000000400000000000000000000000000000002000000010000000200000000000000020000000000000000000000070000000000000070c11a15fd7e4fb55a513adf082255e6fe8f453b65aed289b390a86fd417f6843c6919181068293add92d6ac2c4282d9b4402ccb6659dd3c0000000007000000000000003d4095e6964b607410d342cfd7e97ceb68423cc696a71c2bba70d6db20193faf02a8a58ec39865c14e480d0284c112f81c410fa25fb44f05000000000000000007000000000000004cf1eb706f06d03d15567f91113ea7b3b252a122653ec605b3af97c95b1f0daedfd853de7c5554cc120d5d4b7cf753b93a08298f790748290000000007000000000000005928c8dee1dba8642031a9340008ef7b786b2bc921d627bcce051edbe5f7e2b3a4f569e842a34b7036546b3a8ce5cfead877803ef691df2900000000020000000000000007000000000000002787d345638aeecc284d6321783de8977c5fa27c429c6ee12b05310734261a805ca0c5016336f0c9d6cce02d3e00788773b284e7bad952260000000007000000000000004f9760e3a3d48ff4c611321cea4b91e577243f4f58bc71dd342cc26787406a565b292589d1b5e0e1209669edd36fe4e511cdcd2ddf5ddd1d00000000020000000000000007000000000000005ebac9d155d58db6f3aeb4f5c6cdd0ff8a9129fe6d013c85a575a22920690ef0a7c3f93d9681326e274d35196e56a612b2d5977329f7911e000000000700000000000000ea96e5cb2f4c018e806cf4055ccf88663cafe5fa0fbd328c96cf443c1c0612f5ac3f742cdbb39bb541500e86c9c0a652b80a4f83ac32a4240000000002000000000000000700000000000000f205f2a4f769692d3cde632647d5f0c11c317dcdc95824025f68f82f1a0dad57f8dae130bd63e813806c3e4cd54d2f7c049d5cec50cfc90600000000070000000000000089378c90c50d741d600c7f846ae058b4aada4bbed4f82f93aad69a5f14a19713643277990b13fbfe951e7fe7a1cc9dbf192d95c5ec3c110a0000000002000000000000000000000007000000000000006368f0573a2dcd5059c42e0c97f96b2be31bf01c62183adea83a524d7c84b42e5f58a8be2da455c6734260ea2ed3f5ce8dc9a70c87ea2a05000000000700000000000000cfc6808edb790f02c1f91cac3faf2c9f3b8f9c4fc1228130c107edf72819a7122b197e6eec0dedb1021e35a0f358cf3b527bbaf93b4e852200000000000000000700000000000000fb7a754c2cf4873ca6aeca1d4ddbfa8d055f68927a72385157525a613f6df8a9a5da7486b77f43023162486b9432578e08c6881c7d245620000000000700000000000000d0b5e64d84ff37be9753212d68c9f8eb42d0cae43263c6eca7984af3e039e01044a3c880baa801ecfdead8a912cc0c424fb05b6ef96140280000000002000000000000000700000000000000ea74bf9915e46131dddf2e8cbbe778cb97ab2b68d31c6157d6e0a9621fbd716f51747dcb49a412abcb4b6eb0d22876291413087601113b3c0000000007000000000000007cefc3515d8b9cf18f03fc03e154864e0bbaf1fe7e54e1124bbd50a475ad26727751755600f57b405ed4d07d5f0616e90c7969cd4dfbbd3b00000000020000000000000007000000000000007a46c5d4b7f24a7e3e1983784cc701e6ae2e42f7acb373d7cb33e695853302e4cb0d5c37e0659f0d82509d8e8822d137890feb248bb74325000000000700000000000000424abe9622e2d5c41e6c823057b7ddb64ef1f68cc6ea16b2317ffad826fc697487c4378731faa2d9a868046ded92de15d350cd4ef89d85170000000002000000000000000700000000000000a92dd81a83c4f714129a169a93202354c21925ba932eeb28f5fde6b9309ac74c7b85aac32696f91f0b3781f4318c6fd5673be5f0e9a0fb140000000007000000000000001bd6de8ac98528be291772e76ef2f0941ea27bcb4fb64ca87cf7b7458c3e103569e86326063b745cc4bff4d1b374596f7a5a6b2a7825b409000000000200000000000000000000000700000000000000184575dbe8c6f00df4ec5ff179bdedc771e804dbf8767a1e0ab0185900e0b29d7524d9de3e9405c8e2a86a41772ed30fc4f60ebd6cfa4016000000000700000000000000683f438b4e2887603ad9f507c3ca9506a1213f54f3f6293f9c22faa6f8294a15be6a51b8958dca82abf6fa7277fc803359abb0ec7446752300000000000000000700000000000000f95f09fe2060df7de3e8808bbbd08977f8eb10039aedcfb1ace583746a441217fd974decc988518777d1a92ea5377be783c54476e4c117230000000007000000000000003d89cc357dd12edbcc0fa5a3a089b5c12db7df45d8d884939af1f92ce8f8273381c647a9c9b419d7e918ca8e13f5433d866248ee27ec8e300000000002000000000000000700000000000000d6e28a4b7515d570a33c66d8b5f1242daa0e80090ccba2d229ecca0d09dec812cfb61a41be2a6e758d8af9b9c78e37ddc454a38ee8f04a17000000000700000000000000b53c1066b3623bb88117897736d0f0087ded4ac8d1a84765162f3e9bf14e15b069bdcf4064acbf33f13878b1fef5343fc578646b734ff91d0000000002000000000000000700000000000000947698dace7d637b790cef3da8d993ffafc2d1b8bd0e1df711f18e7d40a0375d3a0a49db031f15b964250671449bff450a0f3770e617f22b00000000070000000000000044fc6fed3b5a2828f432eafdd81f0f3689af66a6b0b6ff03ff0605bf4f80f415c2af79f15e2144d684974c4ff049f2221937d12d13499230000000000002000000010000000000000001000000000000001000000000000000000000000000000000000000',
  bitwidths: [32],
  aclAddress: '0xBCA6F8De823a399Dc431930FD5EE550Bf1C0013e',
  chainId: 11155111,
  ciphertextVersion: 0,
  handles: [
    '0x528d1c1ab80bf0f82867971f56b3345aecbbe45d61000000000000aa36a70400',
  ],
  userAddress: '0x37AC010c1c566696326813b840319B58Bb5840E4',
  contractAddress: '0xb2a8A265dD5A27026693Aa6cE87Fb21Ac197b6b9',
};

describe('handles', () => {
  it('compute from ZkPok', () => {
    const zkProof = ZKProof.fromComponents({
      ciphertextWithZKProof: hexToBytes(DATA.ciphertextWithZKProof),
      aclContractAddress: DATA.aclAddress as ChecksummedAddress,
      chainId: BigInt(DATA.chainId),
      encryptionBits: DATA.bitwidths,
      userAddress: DATA.userAddress,
      contractAddress: DATA.contractAddress,
    });
    const h1 = FhevmHandle.fromZKProof(zkProof, DATA.ciphertextVersion);
    expect(h1[0].toBytes32Hex()).toEqual(DATA.handles[0]);
  });

  it('equivalence testing', () => {
    const ciphertextVersion = 123;
    const zkProof = ZKProof.fromComponents({
      ciphertextWithZKProof: hexToBytes('0xdeadbeef'),
      aclContractAddress:
        '0xBBC1fFCdc7C316aAAd72E807D9b0272BE8F84DA0' as `0x${string}`,
      chainId: BigInt(12345),
      encryptionBits: [256 satisfies EncryptionBits] as EncryptionBits[],
      contractAddress: DATA.contractAddress,
      userAddress: DATA.userAddress,
    });
    const h1 = FhevmHandle.fromZKProof(zkProof, ciphertextVersion);
    const h2 = computeHandles(
      zkProof.ciphertextWithZKProof,
      zkProof.encryptionBits,
      zkProof.aclContractAddress,
      Number(zkProof.chainId),
      ciphertextVersion,
    );
    for (let i = 0; i < h1.length; ++i) {
      expect(h1[i].toBytes32()).toEqual(h2[i]);
      expect(h1[i].toBytes32Hex()).toEqual(ethers.hexlify(h2[i]));
    }
  });
});

function computeHandles(
  ciphertextWithZKProof: Uint8Array,
  bitwidths: readonly EncryptionBits[],
  aclContractAddress: string,
  chainId: number,
  ciphertextVersion: number,
) {
  // Should be identical to:
  // https://github.com/zama-ai/fhevm/blob/e3cd9f3c25851fcbe960c9f337e7214edefe8e64/coprocessor/fhevm-engine/zkproof-worker/src/verifier.rs#L459
  const blob_hash = createHash('keccak256')
    .update(Buffer.from(FhevmHandle.RAW_CT_HASH_DOMAIN_SEPARATOR))
    .update(Buffer.from(ciphertextWithZKProof))
    .digest();
  const aclContractAddress20Bytes = Buffer.from(hexToBytes(aclContractAddress));
  const hex = chainId.toString(16).padStart(64, '0'); // 64 hex chars = 32 bytes
  const chainId32Bytes = Buffer.from(hex, 'hex');
  const handles = bitwidths.map((bitwidth, encryptionIndex) => {
    const encryptionType = fheTypeIdFromEncryptionBits(bitwidth);
    const encryptionIndex1Byte = Buffer.from([encryptionIndex]);
    const handleHash = createHash('keccak256')
      .update(Buffer.from(FhevmHandle.HANDLE_HASH_DOMAIN_SEPARATOR))
      .update(blob_hash)
      .update(encryptionIndex1Byte)
      .update(aclContractAddress20Bytes)
      .update(chainId32Bytes)
      .digest();
    const dataInput = new Uint8Array(32);
    dataInput.set(handleHash, 0);

    // Check if chainId exceeds 8 bytes
    if (BigInt(chainId) > MAX_UINT64) {
      throw new Error('ChainId exceeds maximum allowed value (8 bytes)'); // fhevm assumes chainID is only taking up to 8 bytes
    }

    const chainId8Bytes = hexToBytes(hex).slice(24, 32);
    dataInput[21] = encryptionIndex;
    dataInput.set(chainId8Bytes, 22);
    dataInput[30] = encryptionType;
    dataInput[31] = ciphertextVersion;

    return dataInput;
  });

  return handles;
}
